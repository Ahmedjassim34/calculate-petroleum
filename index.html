<!DOCTYPE html>
<html lang="ar">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تسجيل حضور الموظفين</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Animate.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #6a11cb, #2575fc);
            color: #fff;
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }
        
        .container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        input,
        button {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        button {
            background: #2575fc;
            color: #fff;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        button:hover {
            background: #1b5fd9;
        }
        
        .message {
            margin-top: 20px;
            font-size: 1.2rem;
            font-weight: bold;
        }
    </style>
</head>

<body>

    <div class="container animate__animated animate__fadeIn">
        <h1>نظام تسجيل حضور الموظفين</h1>

        <label for="employeeNumber" class="form-label">رقم الموظف:</label>
        <input type="number" id="employeeNumber" class="form-control" placeholder="ادخل رقم الموظف">

        <button onclick="registerAttendance()" class="btn btn-primary">تسجيل الحضور</button>

        <div class="message" id="message"></div>
    </div>

    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // تهيئة EmailJS باستخدام Public Key
        emailjs.init("YOUR_PUBLIC_KEY"); // استبدل بـ Public Key الخاص بك

        // قائمة الموظفين (يمكن استبدالها بقاعدة بيانات)
        const employees = {
            1: "أحمد جاسم محمد",
            2: "محمد علي حسن",
            3: "فاطمة خالد سعيد",
            4: "علي جاسم محمد",
            5:"مرتضى فؤاد خضير"
        };

        // دالة لتسجيل الحضور
        function registerAttendance() {
            const employeeNumber = document.getElementById('employeeNumber').value;
            if (!employeeNumber) {
                alert("الرجاء إدخال رقم الموظف");
                return;
            }

            // التحقق من أن الموظف مسجل
            const employeeName = employees[employeeNumber];
            if (!employeeName) {
                alert("رقم الموظف غير صحيح");
                return;
            }

            // الحصول على معرف الجهاز (userAgent)
            const deviceId = navigator.userAgent;

            // التحقق من أن الموظف لم يسجل من قبل
            const storedDeviceId = localStorage.getItem(`employee_${employeeNumber}_device`);
            if (storedDeviceId) {
                if (storedDeviceId !== deviceId) {
                    alert("لا يمكن تسجيل الحضور إلا من الجهاز الذي سجلت منه لأول مرة.");
                    return;
                }
            } else {
                // حفظ معرف الجهاز لأول مرة
                localStorage.setItem(`employee_${employeeNumber}_device`, deviceId);
            }

            // تحديد الموقع الجغرافي
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const employeeLocation = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };

                        // عرض رسالة "تم التسجيل بنجاح" للموظف
                        const messageElement = document.getElementById('message');
                        messageElement.textContent = "تم تسجيل الحضور بنجاح.";
                        messageElement.classList.remove('animate__shakeX');
                        messageElement.classList.add('animate__bounceIn');

                        // إرسال بريد إلكتروني إلى المسؤول
                        sendEmailToAdmin(employeeName, employeeLocation);

                        // حفظ حالة التسجيل في localStorage
                        localStorage.setItem(`employee_${employeeNumber}_registered`, true);
                    },
                    (error) => {
                        alert("تعذر تحديد الموقع. الرجاء المحاولة مرة أخرى.");
                        document.getElementById('message').textContent = "تعذر تحديد الموقع.";
                    }
                );
            } else {
                alert("المتصفح لا يدعم تحديد الموقع الجغرافي.");
                document.getElementById('message').textContent = "المتصفح لا يدعم تحديد الموقع.";
            }
        }

        // دالة لإرسال بريد إلكتروني إلى المسؤول
        function sendEmailToAdmin(employeeName, employeeLocation) {
            const templateParams = {
                to_name: "المسؤول",
                employee_name: employeeName,
                latitude: employeeLocation.latitude,
                longitude: employeeLocation.longitude
            };

            emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", templateParams)
                .then((response) => {
                    console.log("تم إرسال البريد الإلكتروني بنجاح!", response.status, response.text);
                }, (error) => {
                    console.error("فشل إرسال البريد الإلكتروني:", error);
                });
        }
    </script>

</body>

</html>
